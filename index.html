<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶æŠ¥å - æ´»åŠ¨ä¸­å¿ƒ</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 20px auto; padding: 0 15px; background-color: #f4f4f4; }
        .container { background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1, h2 { color: #0056b3; border-bottom: 2px solid #0056b3; padding-bottom: 10px; }
        .signup-section { background-color: #e9f5ff; padding: 15px; border-radius: 8px; margin-bottom: 25px; border: 1px solid #b3d7ff; }
        .form-container { display: flex; gap: 10px; margin-bottom: 15px; }
        #nameInput { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1em; }
        #submitBtn { padding: 10px 20px; border: none; background-color: #007bff; color: white; border-radius: 4px; cursor: pointer; font-size: 1em; white-space: nowrap; }
        #submitBtn:hover { background-color: #0056b3; }
        .slots-container label { font-weight: bold; display: block; margin-bottom: 10px; }
        .slot-checkbox { display: flex; align-items: center; margin-bottom: 8px; }
        .slot-checkbox input { width: 18px; height: 18px; margin-right: 10px; }
        .slot-checkbox span { font-size: 1.1em; }
        .slot-accordion .slot-header { background-color: #f0f0f0; padding: 12px; margin-top: 10px; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s; }
        .slot-accordion .slot-header:hover { background-color: #e0e0e0; }
        .slot-accordion .slot-header h3 { margin: 0; font-size: 1.1em; flex-grow: 1; }
        .slot-accordion .participant-count { font-weight: normal; color: #555; margin-left: 10px; }
        .slot-accordion .participant-list { padding-left: 20px; border-left: 3px solid #007bff; margin-top: 0; margin-bottom: 10px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .slot-accordion.active .participant-list { max-height: 500px; padding-top: 10px; }
        .slot-accordion .participant-list li { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 5px; }
        .delete-btn { background: none; border: none; color: #dc3545; font-size: 1.4em; font-weight: bold; cursor: pointer; padding: 0 5px; line-height: 1; }
        .delete-btn:hover { color: #a71d2a; }
        .arrow { border: solid black; border-width: 0 2px 2px 0; display: inline-block; padding: 3px; transform: rotate(45deg); transition: transform 0.3s; margin-left: 15px; }
        .slot-accordion.active .arrow { transform: rotate(-135deg); }
        #no-slots-message { text-align: center; padding: 20px; background-color: #f8f9fa; border-radius: 4px; color: #6c757d; }
        .admin-toggle { text-align: center; margin-top: 20px; }
        .admin-toggle button { background: none; border: none; color: #6c757d; cursor: pointer; text-decoration: underline; }
        #admin-panel { display: none; background-color: #fffbe6; border: 1px solid #ffe58f; padding: 15px; border-radius: 8px; margin-top: 15px; }
        #admin-panel h3 { margin-top: 0; }
        .admin-form-group { margin-bottom: 10px; }
        .admin-form-group label { display: block; margin-bottom: 5px; }
        .admin-form-group input, .admin-form-group select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; font-size: 1em; box-sizing: border-box; }
        .admin-form-group button { padding: 10px 15px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .delete-slot-btn { display: none; background: none; border: none; cursor: pointer; font-size: 1.2em; margin-left: 10px; }
        .admin-mode .delete-slot-btn { display: inline-block; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ä½ æ¥æ‰“çƒå—ï¼ï¼Ÿï¼ï¼Ÿ</h1>
        <div class="signup-section">
            <h2>1. æˆ‘è¦æŠ¥åï¼ï¼ï¼</h2>
            <div class="form-container">
                <input type="text" id="nameInput" placeholder="ä½ å«å•¥">
                <button id="submitBtn">æŠ¥åï¼</button>
            </div>
            <div id="slots-checkbox-container">
                <label>ä½ è¦æ‰“å“ªäº›ï¼š</label>
                <!-- Checkboxes will be dynamically inserted here -->
            </div>
        </div>
        <h2>2. éƒ½æœ‰è°</h2>
        <div id="slots-accordion-container">
            <!-- Accordion lists will be dynamically inserted here -->
        </div>
        <div class="admin-toggle">
            <button id="admin-login-btn">ç®¡ç†å‘˜å…¥å£</button>
        </div>
        <div id="admin-panel">
            <h3>ç®¡ç†å‘˜åå° (è‡ªåŠ¨å‘½å)</h3>
            <div class="admin-form-group">
                <label for="new-slot-date">é€‰æ‹©æ—¥æœŸ</label>
                <input type="date" id="new-slot-date">
            </div>
            <div class="admin-form-group">
                <label for="new-slot-time">é€‰æ‹©å¼€å§‹æ—¶é—´ (æ•´ç‚¹/åŠç‚¹)</label>
                <select id="new-slot-time"></select>
            </div>
             <div class="admin-form-group">
                <label for="new-slot-duration">é€‰æ‹©æ€»æ—¶é•¿</label>
                <select id="new-slot-duration"></select>
            </div>
            <div class="admin-form-group">
                <button id="add-slot-btn">æ·»åŠ æ–°åœºæ¬¡</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // =================================================================================
        // ==  åœ¨è¿™é‡Œè®¾ç½®ä½ çš„ç®¡ç†å‘˜å¯†ç  (åªéœ€è¦è®¾ç½®è¿™ä¸€æ¬¡ï¼)  ==
        // =================================================================================
        const ADMIN_PASSWORD = "change_this_password"; // å¼ºçƒˆå»ºè®®ä¿®æ”¹æˆä½ è‡ªå·±çš„å¯†ç 
        // =================================================================================

        const firebaseConfig = {
            apiKey: "AIzaSyBczhQyTGzdUceUiec9zLEpK5TpA4rApSw",
            authDomain: "ni-lai-da-qiu-ma.firebaseapp.com",
            databaseURL: "https://ni-lai-da-qiu-ma-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "ni-lai-da-qiu-ma",
            storageBucket: "ni-lai-da-qiu-ma.firebasestorage.app",
            messagingSenderId: "526261240346",
            appId: "1:526261240346:web:20f74aeb74f7c12d3047a3",
            measurementId: "G-2F4GJDW2DP"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const slotsDefRef = database.ref('_event_definitions');

        const mainContainer = document.querySelector('.container');
        const nameInput = document.getElementById('nameInput');
        const submitBtn = document.getElementById('submitBtn');
        const slotsCheckboxContainer = document.getElementById('slots-checkbox-container');
        const slotsAccordionContainer = document.getElementById('slots-accordion-container');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const adminPanel = document.getElementById('admin-panel');
        const addSlotBtn = document.getElementById('add-slot-btn');
        const timeSelect = document.getElementById('new-slot-time');
        const durationSelect = document.getElementById('new-slot-duration');

        let participantsBySlot = {};
        let availableSlots = [];

        function populateAdminControls() {
            for (let i = 0; i < 24; i++) {
                let hour = i.toString().padStart(2, '0');
                timeSelect.options.add(new Option(`${hour}:00`, `${hour}:00`));
                timeSelect.options.add(new Option(`${hour}:30`, `${hour}:30`));
            }
            const durations = [1, 1.5, 2, 2.5, 3, 3.5, 4];
            durations.forEach(d => durationSelect.options.add(new Option(`${d} å°æ—¶`, d)));
        }
        populateAdminControls();

        function formatDisplayLabel(slot) {
            const startDate = new Date(slot.startTime);
            const endDate = new Date(slot.endTime);
            const optionsTime = { hour: '2-digit', minute: '2-digit', hour12: false };
            const startTimeStr = startDate.toLocaleTimeString('zh-CN', optionsTime);
            const endTimeStr = endDate.toLocaleTimeString('zh-CN', optionsTime);
            return `${slot.label} (${startTimeStr} - ${endTimeStr})`;
        }

        slotsDefRef.on('value', (snapshot) => {
            const allDefinedSlotsData = snapshot.val();
            let allDefinedSlots = [];
            if (allDefinedSlotsData) {
                allDefinedSlots = Object.keys(allDefinedSlotsData).map(key => ({ id: key, ...allDefinedSlotsData[key] }));
            }
            const now = new Date();
            availableSlots = allDefinedSlots
                .filter(slot => new Date(slot.startTime) > now)
                .sort((a, b) => new Date(a.startTime) - new Date(b.startTime));
            renderPage();
        });

        function renderPage() {
            slotsCheckboxContainer.innerHTML = '<label>è¯·é€‰æ‹©è¦å‚åŠ çš„åœºæ¬¡ï¼š</label>';
            slotsAccordionContainer.innerHTML = '';
            if (availableSlots.length > 0) {
                availableSlots.forEach(slot => {
                    const displayLabel = formatDisplayLabel(slot);
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'slot-checkbox';
                    checkboxDiv.innerHTML = `<input type="checkbox" id="check-${slot.id}" data-slot-id="${slot.id}"><label for="check-${slot.id}"><span>${displayLabel}</span></label>`;
                    slotsCheckboxContainer.appendChild(checkboxDiv);
                    
                    const accordionDiv = document.createElement('div');
                    accordionDiv.className = 'slot-accordion';
                    accordionDiv.id = `accordion-${slot.id}`;
                    accordionDiv.innerHTML = `
                        <div class="slot-header">
                            <h3>${displayLabel}</h3>
                            <button class="delete-slot-btn" data-slot-id="${slot.id}" title="åˆ é™¤æ•´ä¸ªåœºæ¬¡">ğŸ—‘ï¸</button>
                            <span class="participant-count">0</span>äºº
                            <i class="arrow"></i>
                        </div>
                        <ul class="participant-list"></ul>`;
                    slotsAccordionContainer.appendChild(accordionDiv);
                    
                    listenToSlotParticipants(slot.id);
                });
                document.querySelector('.signup-section .form-container').style.display = 'flex';
            } else {
                slotsCheckboxContainer.innerHTML = '<p id="no-slots-message">å½“å‰æ²¡æœ‰å¯æŠ¥åçš„åœºæ¬¡ï¼Œè¯·ç­‰å¾…ç»„ç»‡è€…å‘å¸ƒã€‚</p>';
                document.querySelector('.signup-section .form-container').style.display = 'none';
            }
        }

        function listenToSlotParticipants(slotId) {
            const participantsRef = database.ref('games/' + slotId);
            participantsRef.on('value', (snapshot) => {
                const participantsData = snapshot.val();
                const accordion = document.getElementById(`accordion-${slotId}`);
                if (!accordion) return;
                const listElement = accordion.querySelector('.participant-list');
                const countElement = accordion.querySelector('.participant-count');
                listElement.innerHTML = '';
                participantsBySlot[slotId] = [];
                let count = 0;
                if (participantsData) {
                    for (const key in participantsData) {
                        const name = participantsData[key].name;
                        participantsBySlot[slotId].push(name.toLowerCase().trim());
                        const li = document.createElement('li');
                        li.dataset.key = key;
                        li.innerHTML = `<span>${name}</span><button class="delete-btn" title="åˆ é™¤">&times;</button>`;
                        listElement.appendChild(li);
                        count++;
                    }
                }
                countElement.textContent = count;
            });
        }

        adminLoginBtn.addEventListener('click', () => {
            const pass = prompt("è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç :");
            if (pass === ADMIN_PASSWORD) {
                mainContainer.classList.add('admin-mode');
                adminPanel.style.display = 'block';
                alert("æ¬¢è¿å›æ¥ï¼Œç®¡ç†å‘˜ï¼");
            } else if (pass) {
                alert("å¯†ç é”™è¯¯ï¼");
            }
        });

        addSlotBtn.addEventListener('click', () => {
            const dateValue = document.getElementById('new-slot-date').value;
            const timeValue = document.getElementById('new-slot-time').value;
            const durationHours = parseFloat(document.getElementById('new-slot-duration').value);

            if (!dateValue || !timeValue || !durationHours) {
                alert("æ‰€æœ‰å­—æ®µéƒ½ä¸èƒ½ä¸ºç©ºï¼"); return;
            }

            const startDate = new Date(`${dateValue}T${timeValue}`);
            const endDate = new Date(startDate.getTime() + durationHours * 60 * 60 * 1000);
            
            const options = { month: 'numeric', day: 'numeric', weekday: 'short' };
            const autoLabel = startDate.toLocaleDateString('zh-CN', options);

            slotsDefRef.push({ label: autoLabel, startTime: startDate.toISOString(), endTime: endDate.toISOString() });

            document.getElementById('new-slot-date').value = '';
            alert("æ–°åœºæ¬¡æ·»åŠ æˆåŠŸï¼é¡µé¢å°†è‡ªåŠ¨æ›´æ–°ã€‚");
        });

        slotsAccordionContainer.addEventListener('click', function(event) {
            const target = event.target;
            if (target.classList.contains('delete-btn')) {
                const li = target.closest('li');
                const key = li.dataset.key;
                const accordion = li.closest('.slot-accordion');
                const slotId = accordion.id.replace('accordion-', '');
                const name = li.querySelector('span').textContent;
                const slot = availableSlots.find(s => s.id === slotId);
                if (slot && confirm(`ç¡®å®šè¦ä»ã€${formatDisplayLabel(slot)}ã€‘ä¸­åˆ é™¤â€œ${name}â€å—ï¼Ÿ`)) {
                    database.ref('games/' + slotId + '/' + key).remove();
                }
                return;
            }
            if (target.classList.contains('delete-slot-btn')) {
                const slotId = target.dataset.slotId;
                const slot = availableSlots.find(s => s.id === slotId);
                if (slot && confirm(`ã€è­¦å‘Šã€‘\nç¡®å®šè¦æ°¸ä¹…åˆ é™¤æ•´ä¸ªã€${formatDisplayLabel(slot)}ã€‘åœºæ¬¡åŠå…¶æ‰€æœ‰æŠ¥åè®°å½•å—ï¼Ÿ\n\næ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼`)) {
                    const slotDefPromise = slotsDefRef.child(slotId).remove();
                    const slotGamesPromise = database.ref('games/' + slotId).remove();
                    Promise.all([slotDefPromise, slotGamesPromise]).then(() => {
                        alert("åœºæ¬¡å·²æˆåŠŸåˆ é™¤ã€‚");
                    });
                }
                return;
            }
            const header = target.closest('.slot-header');
            if (header) {
                header.parentElement.classList.toggle('active');
            }
        });

        function signUp() {
            const name = nameInput.value.trim();
            if (!name) { alert("è¯·è¾“å…¥ä½ çš„åå­—ï¼"); return; }
            const selectedCheckboxes = document.querySelectorAll('#slots-checkbox-container input[type="checkbox"]:checked');
            if (selectedCheckboxes.length === 0) { alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦æŠ¥åçš„åœºæ¬¡ï¼"); return; }
            let successCount = 0;
            let alreadyJoined = [];
            selectedCheckboxes.forEach(checkbox => {
                const slotId = checkbox.dataset.slotId;
                const currentParticipants = participantsBySlot[slotId] || [];
                const slot = availableSlots.find(s => s.id === slotId);
                if (slot) {
                    if (currentParticipants.includes(name.toLowerCase())) {
                        alreadyJoined.push(formatDisplayLabel(slot));
                    } else {
                        database.ref('games/' + slotId).push({ name: name });
                        successCount++;
                    }
                }
            });
            let feedbackMessage = "";
            if (successCount > 0) { feedbackMessage += `æˆåŠŸæŠ¥å ${successCount} ä¸ªåœºæ¬¡ï¼\n`; }
            if (alreadyJoined.length > 0) { feedbackMessage += `ä½ å·²æŠ¥è¿‡åï¼Œæ— éœ€é‡å¤æŠ¥åä»¥ä¸‹åœºæ¬¡ï¼š\n- ${alreadyJoined.join('\n- ')}`; }
            alert(feedbackMessage);
            nameInput.value = '';
            selectedCheckboxes.forEach(cb => cb.checked = false);
        }

        submitBtn.addEventListener('click', signUp);
    </script>
</body>
</html>

